<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MSK Special Tests ‚Äî Drag & Match</title>
<style>
  :root { --bg:#0f1220; --panel:#161a2e; --card:#1b2040; --muted:#9aa4bf; --ok:#2ecc71; --bad:#ff6b6b; --accent:#7c5cff; --accent2:#00d1ff; --ink:#e9ecff; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
        background:radial-gradient(1200px 600px at 10% 0%, #121633 0%, var(--bg) 60%);
        color:var(--ink); min-height:100dvh; padding:24px; display:flex; align-items:center; justify-content:center; }
  .app{ width:min(1200px,100%); display:grid; gap:16px }
  h1{ margin:0; font-size:clamp(22px,3.4vw,36px); font-weight:800; letter-spacing:.2px;
      background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .lead{ margin:4px 0 0; color:var(--muted) }
  .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
  .btn,.pill,select{ background:#20254a; color:var(--ink); border:1px solid #2c3258; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
  select{ padding:10px 10px }
  .btn:hover{ border-color:var(--accent) }
  .pill{ display:inline-flex; align-items:center; gap:8px; user-select:none }
  .pill input{ accent-color:var(--accent); width:18px; height:18px }
  .meta{ margin-left:auto; display:flex; gap:12px; color:var(--muted); flex-wrap:wrap; align-items:center }
  .score,.time{ font-variant-numeric: tabular-nums; color:#fff; font-weight:800 }
  .board{ position:relative; display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px }
  @media (max-width:980px){ .board{ grid-template-columns:1fr } }
  .col{ background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.2));
        border:1px solid #2c3258; border-radius:16px; padding:12px; display:grid; gap:10px; }
  .col h2{ margin:0; font-size:14px; letter-spacing:1px; text-transform:uppercase; color:#c9cff7; display:flex; justify-content:space-between }
  .stack{ display:grid; gap:10px; min-height:320px }
  .card{ background:var(--card); border:1px solid #2b3160; border-radius:12px; padding:12px; line-height:1.25;
         cursor:grab; user-select:none; outline:none; transition:transform .08s ease, border-color .12s ease, background-color .12s ease, box-shadow .12s ease; }
  .card:active{ cursor:grabbing }
  .card:hover{ transform:translateY(-1px); border-color:#3a4184 }
  .card[data-col="B"]{ border-left:4px solid var(--accent) }
  .card[data-col="A"]{ border-left:4px solid #6fd3a6 }
  .card[data-col="C"]{ border-left:4px solid #f8c77e }
  .card.highlight{ box-shadow:0 0 0 2px rgba(124,92,255,.35) inset }
  .card.correct{ border-color:var(--ok); background:#143524 }
  .card.wrong{ border-color:var(--bad); background:#3a1c1c }
  .card.locked{ opacity:.95; cursor:default }
  .toast{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#1f2544; border:1px solid #343c73;
          padding:10px 14px; border-radius:10px; display:none; font-weight:700; }
  .toast.show{ display:inline-block }
  .wires{ position:absolute; inset:0; pointer-events:none }
  footer{ color:var(--muted); font-size:13px; text-align:center }

  .panel{ background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.2)); border:1px solid #2c3258; border-radius:16px; padding:12px; }
  .lb-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; margin-top:6px }
  .lb-title{ font-weight:800; color:#c9cff7 }
  table{ width:100%; border-collapse:separate; border-spacing:0 }
  th,td{ text-align:left; padding:8px; vertical-align:top; font-size:14px }
  thead th{ position:sticky; top:0; background:#1f2544; border-bottom:1px solid #343c73; color:#c9cff7; text-transform:uppercase; font-size:12px; letter-spacing:.5px }
  tbody tr:nth-child(odd){ background:#161a2e }
  tbody tr:nth-child(even){ background:#131730 }
  .tiny{ color:var(--muted); font-size:12px }

  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
  .modal.open{ display:flex }
  .modal-card{ background:#141938; border:1px solid #343c73; border-radius:14px; padding:16px; width:min(420px,92%) }
  .modal-card h3{ margin:0 0 8px }
  .field{ display:grid; gap:6px; margin:8px 0 }
  .field input{ padding:10px; border-radius:10px; border:1px solid #2b3160; background:#0e1230; color:#fff }
  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }
</style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <h1>Drag & Match ‚Äî MSK Special Tests</h1>
      <p class="lead">Drag a <strong>Test</strong> (middle) onto its <strong>Body Part</strong> (left), then drag the matching <strong>Meaning</strong> (right). Race the clock!</p>
      <div class="controls">
        <button class="btn" id="btn-shuffle">üîÄ New Shuffle</button>
        <button class="btn" id="btn-reset">‚ôªÔ∏è Reset</button>
        <label class="pill"><input type="checkbox" id="toggle-hints" /> Show hints</label>

        <!-- Mode controls -->
        <label class="pill" title="Toggle countdown (race) mode">
          <input type="checkbox" id="toggle-countdown" />
          Countdown mode
        </label>
        <select id="race-duration" title="Countdown duration">
          <option value="60000">1:00</option>
          <option value="120000" selected>2:00</option>
          <option value="180000">3:00</option>
          <option value="300000">5:00</option>
        </select>

        <!-- Share class link -->
        <button class="btn" id="btn-share" title="Copy a link with this class code">üîó Share class link</button>

        <div class="meta">
          <span>Solved: <span class="score" id="score">0</span>/<span id="total">0</span></span>
          <span>Tries: <span class="score" id="tries">0</span></span>
          <span>Time: <span class="time" id="time">00:00.0</span></span>
          <span>Best: <span class="time" id="best">‚Äî</span></span>
          <span class="tiny" id="classLabel"></span>
        </div>
      </div>
    </header>

    <section class="board" id="board">
      <svg class="wires" id="wires" aria-hidden="true"></svg>

      <div class="col" data-col="A"><h2>Body Part <span>A</span></h2><div class="stack" id="col-A"></div></div>
      <div class="col" data-col="B"><h2>Special Test <span>B</span></h2><div class="stack" id="col-B"></div></div>
      <div class="col" data-col="C"><h2>Meaning <span>C</span></h2><div class="stack" id="col-C"></div></div>
    </section>

    <!-- Leaderboard -->
    <section class="panel" id="panel-lb">
      <div class="lb-head">
        <div>
          <div class="lb-title">Leaderboard <span class="tiny" id="lbClass"></span></div>
          <div class="tiny">Top 10 fastest runs on this device.</div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn" id="btn-export">‚¨áÔ∏è CSV</button>
          <button class="btn" id="btn-reset-lb" title="Clear leaderboard">üóë Reset</button>
        </div>
      </div>
      <div style="overflow:auto; max-height:40vh; margin-top:8px">
        <table aria-label="Leaderboard table">
          <thead><tr><th>#</th><th>Name</th><th>Time</th><th>Tries</th><th>Date</th></tr></thead>
          <tbody id="lb-body"></tbody>
        </table>
      </div>
    </section>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <footer>Tip: use <code>?class=GROUPA</code> in the URL to separate classes (e.g., <code>.../?class=Year1</code>).</footer>
  </div>

  <!-- Modal: enter name after a run -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <h3 id="modalTitle">Great run! Save your time to the leaderboard</h3>
      <div class="field">
        <label for="name">Name / Initials</label>
        <input id="name" maxlength="20" placeholder="e.g., AB or Alex B" />
      </div>
      <div class="tiny">Time: <span id="modalTime">00:00.0</span> ‚Ä¢ Tries: <span id="modalTries">0</span></div>
      <div class="actions">
        <button class="btn" id="btn-cancel">Cancel</button>
        <button class="btn" id="btn-save">Save</button>
      </div>
    </div>
  </div>

<script>
/* ========= Dataset ========= */
const DATA = [
  { id:"shoulder-hawkins-imp", A:"Shoulder", B:"Hawkins‚ÄìKennedy Test", C:"Screens for subacromial impingement" },
  { id:"shoulder-emptycan-ss", A:"Shoulder", B:"Jobe / Empty Can Test", C:"Assesses supraspinatus tendinopathy or tear" },
  { id:"shoulder-apprehension", A:"Shoulder", B:"Apprehension‚ÄìRelocation Test", C:"Assesses anterior shoulder instability" },
  { id:"shoulder-speeds-lhb", A:"Shoulder", B:"Speed‚Äôs Test", C:"Suggests long head of biceps tendinopathy" },
  { id:"knee-lachman-acl", A:"Knee", B:"Lachman Test", C:"Assesses anterior cruciate ligament (ACL) integrity" },
  { id:"knee-mcmurray-meniscus", A:"Knee", B:"McMurray Test", C:"Detects meniscal tear" },
  { id:"knee-thessaly-meniscus", A:"Knee", B:"Thessaly Test", C:"Screens for meniscal pathology under load" },
  { id:"knee-varus-lcl", A:"Knee", B:"Varus Stress Test (30¬∞)", C:"Assesses lateral collateral ligament (LCL)" },
  { id:"hip-faber-sij", A:"Hip / SIJ", B:"FABER (Patrick‚Äôs) Test", C:"Evaluates hip or sacroiliac joint pathology" },
  { id:"hip-fadir-imp", A:"Hip / SIJ", B:"FADIR Test", C:"Provokes femoroacetabular impingement symptoms" },
  { id:"hip-trendelenburg", A:"Hip / SIJ", B:"Trendelenburg Sign", C:"Suggests gluteus medius weakness" },
  { id:"elbow-cozen-tennis", A:"Elbow", B:"Cozen‚Äôs Test", C:"Identifies lateral epicondylitis (tennis elbow)" },
  { id:"elbow-mills-tennis", A:"Elbow", B:"Mill‚Äôs Test", C:"Stretches/worsens lateral epicondylitis pain" },
  { id:"elbow-maudsley-tennis", A:"Elbow", B:"Maudsley‚Äôs Test", C:"Pain with resisted 3rd finger extension ‚Üí tennis elbow" },
  { id:"wrist-finkelstein", A:"Wrist/Hand", B:"Finkelstein‚Äôs Test", C:"Detects de Quervain‚Äôs tenosynovitis" },
  { id:"wrist-phalen-cts", A:"Wrist/Hand", B:"Phalen‚Äôs Test", C:"Provokes carpal tunnel syndrome symptoms" },
  { id:"wrist-tinel-cts", A:"Wrist/Hand", B:"Tinel‚Äôs at Carpal Tunnel", C:"Paresthesia over median nerve (CTS)" },
  { id:"ankle-thompson-achilles", A:"Ankle/Foot", B:"Thompson Test", C:"Checks for Achilles tendon rupture" },
  { id:"ankle-antdrawer-atfl", A:"Ankle/Foot", B:"Anterior Drawer Test (ankle)", C:"Assesses ATFL laxity/tear" },
  { id:"foot-morton-neuroma", A:"Ankle/Foot", B:"Morton‚Äôs Squeeze Test", C:"Suggests interdigital (Morton‚Äôs) neuroma" },
  { id:"cspine-spurling", A:"Cervical Spine", B:"Spurling‚Äôs Test", C:"Reproduces radicular pain ‚Üí cervical radiculopathy" },
  { id:"lspine-slr", A:"Lumbar Spine", B:"Straight Leg Raise", C:"Stretches sciatic nerve ‚Üí lumbar radiculopathy" },
  { id:"tost-adson", A:"Thoracic Outlet", B:"Adson‚Äôs Test", C:"Diminished pulse/paresthesia ‚Üí TOS (scalene compression)" },
  { id:"tost-roos", A:"Thoracic Outlet", B:"Roos / EAST", C:"Provocation of TOS symptoms with sustained elevation" },
];

/* ========= Class namespace & share ========= */
const params = new URLSearchParams(location.search);
const CLASS_CODE = (params.get("class") || "default").trim();
document.getElementById("classLabel").textContent = `Class: ${CLASS_CODE}`;
document.getElementById("lbClass").textContent = `(class: ${CLASS_CODE})`;
document.getElementById("btn-share").addEventListener("click", async ()=>{
  const url = `${location.origin}${location.pathname}?class=${encodeURIComponent(CLASS_CODE||"default")}`;
  try{ await navigator.clipboard.writeText(url); toast("‚úÖ Class link copied!"); }catch{ prompt("Copy this link:", url); }
});

/* ========= Keys ========= */
const LS_KEY_BEST = `mskMatchBestMs__${CLASS_CODE}`;          // Stopwatch ‚Äúbest‚Äù
const LS_KEY_LB   = `mskMatchLeaderboardV1__${CLASS_CODE}`;    // Leaderboard

/* ========= State ========= */
const state = {
  tries: 0,
  lockedIds: new Set(),
  pairAB: new Map(), pairAC: new Map(),
  nodeMap: { A:[], B:[], C:[] },
  // timing
  timerRunning:false, tick:null,
  mode:"stopwatch",       // "stopwatch" | "countdown"
  raceLimitMs:120000,     // used when countdown
  startMs:0, elapsedMs:0, // stopwatch elapsed or countdown remaining computed from these
};
const $ = s => document.querySelector(s);
const el = (t,p={},...kids)=>{ const n=Object.assign(document.createElement(t),p); kids.forEach(k=>n.append(k)); return n; };
const shuffle = a => { const b=a.slice(); for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [b[i],b[j]]=[b[j],b[i]];} return b; };

/* ========= Toast ========= */
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.className="toast show"; setTimeout(()=>t.className="toast",1400); }

/* ========= Time helpers ========= */
function formatMs(ms){
  const positive = Math.max(0, ms);
  const m = Math.floor(positive/60000);
  const s = Math.floor((positive%60000)/1000);
  const d = Math.floor((positive%1000)/100);
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${d}`;
}
function updateTimeUI(){
  if(state.mode==="stopwatch"){
    $("#time").textContent = formatMs(state.elapsedMs);
    $("#best").textContent = localStorage.getItem(LS_KEY_BEST) ? formatMs(Number(localStorage.getItem(LS_KEY_BEST))) : "‚Äî";
  } else {
    // countdown: show remaining
    const elapsed = performance.now() - state.startMs;
    const remaining = Math.max(0, state.raceLimitMs - elapsed);
    $("#time").textContent = formatMs(remaining);
    $("#best").textContent = "‚Äî"; // best is for stopwatch only
  }
}
function startTimer(){
  if(state.timerRunning) return;
  state.timerRunning = true;
  state.startMs = performance.now();
  state.tick = setInterval(()=>{
    if(state.mode==="stopwatch"){
      state.elapsedMs = performance.now() - state.startMs;
      updateTimeUI();
    } else {
      const elapsed = performance.now() - state.startMs;
      if(elapsed >= state.raceLimitMs){
        // time up!
        clearInterval(state.tick); state.tick=null; state.timerRunning=false;
        $("#time").textContent = "00:00.0";
        toast("‚è∞ Time up ‚Äî DNF");
        // disable saving to leaderboard by showing modal with disabled save
        showSaveModal(true); // DNF
      } else {
        updateTimeUI();
      }
    }
  }, 100);
}
function stopTimerAndMaybeSetBest(){
  if(!state.timerRunning) return;
  clearInterval(state.tick); state.tick=null; state.timerRunning=false;
  if(state.mode==="stopwatch"){
    state.elapsedMs = performance.now() - state.startMs;
    updateTimeUI();
    const bestRaw = localStorage.getItem(LS_KEY_BEST);
    if(!bestRaw || state.elapsedMs < Number(bestRaw)){
      localStorage.setItem(LS_KEY_BEST, String(state.elapsedMs));
      toast("üèÅ New best time!");
    }
  } else {
    // countdown finish early ‚Äî keep elapsed for leaderboard display
    state.elapsedMs = performance.now() - state.startMs;
    updateTimeUI();
  }
}
function resetTimerUI(){
  if(state.tick){ clearInterval(state.tick); state.tick=null; }
  state.timerRunning=false; state.elapsedMs=0; state.startMs=0;
  updateTimeUI();
}

/* ========= Leaderboard ========= */
function loadLB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_LB)||"[]"); }catch{ return []; } }
function saveLB(rows){ localStorage.setItem(LS_KEY_LB, JSON.stringify(rows)); }
function addToLB(name, ms, tries){
  const rows = loadLB();
  rows.push({ name: name || "Anon", ms, tries, date: new Date().toISOString() });
  rows.sort((a,b)=>a.ms-b.ms);
  saveLB(rows.slice(0, 20));
  renderLB();
}
function renderLB(){
  const tbody = $("#lb-body");
  const rows = loadLB().slice(0,10);
  tbody.innerHTML = "";
  if(rows.length===0){
    const tr=el("tr",{}, el("td",{colSpan:5}, "No scores yet ‚Äî be the first!"));
    tbody.appendChild(tr); return;
  }
  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    const dt = new Date(r.date);
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${formatMs(r.ms)}</td>
      <td>${r.tries}</td>
      <td>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</td>`;
    tbody.appendChild(tr);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function exportLB(){
  const rows = loadLB().sort((a,b)=>a.ms-b.ms);
  const header = ["Rank","Name","Time (ms)","Time (mm:ss.d)","Tries","Date ISO"];
  const lines = [header.join(",")];
  rows.forEach((r,i)=> lines.push([i+1, `"${r.name.replace(/"/g,'""')}"`, r.ms, formatMs(r.ms), r.tries, r.date].join(",")));
  const csv = lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=`leaderboard_${CLASS_CODE}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* ========= Build Board ========= */
function dedupeByLabel(arr){ const seen=new Set(), out=[]; for(const x of arr){ if(!seen.has(x.label)){ seen.add(x.label); out.push(x); } } return out; }

function buildBoard(){
  state.tries=0; state.lockedIds.clear(); state.pairAB.clear(); state.pairAC.clear();
  $("#tries").textContent="0"; $("#score").textContent="0"; $("#total").textContent=String(DATA.length);
  ["A","B","C"].forEach(k=>$("#col-"+k).innerHTML="");
  state.nodeMap={A:[],B:[],C:[]};
  $("#wires").innerHTML=""; defineGradientsOnce();
  resetTimerUI();

  const packA = shuffle(dedupeByLabel(DATA.map(d=>({col:"A", id:`A-${d.A}`, label:d.A}))));
  const packB = shuffle(DATA.map(d=>({col:"B", id:d.id, label:d.B})));
  const packC = shuffle(DATA.map(d=>({col:"C", id:d.id, label:d.C})));

  for(const card of packA){ const node=renderCard(card); $("#col-A").append(node); state.nodeMap.A.push({data:card,node}); }
  for(const card of packB){ const node=renderCard(card); $("#col-B").append(node); state.nodeMap.B.push({data:card,node}); }
  for(const card of packC){ const node=renderCard(card); $("#col-C").append(node); state.nodeMap.C.push({data:card,node}); }
}

/* ========= Cards & DnD ========= */
function renderCard(card){
  const node = el("div",{className:"card","data-col":card.col,"data-id":card.id,draggable:card.col!=="A"},card.label);
  if(card.col==="A"){
    node.addEventListener("dragover", e=>{
      if(dragPayload && ["B","C"].includes(dragPayload.col) && !node.classList.contains("locked")) e.preventDefault();
      node.classList.add("highlight");
    });
    node.addEventListener("dragleave", ()=> node.classList.remove("highlight"));
    node.addEventListener("drop", e=>onDropOnA(e,node));
  } else {
    node.addEventListener("dragstart", e=>{
      if(node.classList.contains("locked")){ e.preventDefault(); return; }
      dragPayload={col:card.col,id:card.id,node};
      node.classList.add("highlight");
      startTimer(); // start timing on first drag
    });
    node.addEventListener("dragend", ()=>{ dragPayload=null; node.classList.remove("highlight"); });
  }
  return node;
}

let dragPayload=null;

function onDropOnA(e,aNode){
  e.preventDefault();
  aNode.classList.remove("highlight");
  if(!dragPayload) return;
  const kind=dragPayload.col, draggedId=dragPayload.id;
  if(kind==="B") state.pairAB.set(aNode,draggedId);
  if(kind==="C") state.pairAC.set(aNode,draggedId);

  drawProvisionalWiresForA(aNode);

  if(state.pairAB.has(aNode) && state.pairAC.has(aNode)){
    checkTripleForA(aNode);
  }
}

/* ========= Wire Drawing ========= */
function defineGradientsOnce(){
  if(document.getElementById("gradAB")) return;
  const svg=$("#wires");
  const defs=document.createElementNS("http://www.w3.org/2000/svg","defs");

  const gradAB=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
  gradAB.id="gradAB"; gradAB.setAttribute("x1","0%"); gradAB.setAttribute("x2","100%");
  gradAB.innerHTML='<stop offset="0%" stop-color="#7c5cff"/><stop offset="100%" stop-color="#00d1ff"/>';
  const gradAC=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
  gradAC.id="gradAC"; gradAC.setAttribute("x1","0%"); gradAC.setAttribute("x2","100%");
  gradAC.innerHTML='<stop offset="0%" stop-color="#f8c77e"/><stop offset="100%" stop-color="#7c5cff"/>';

  defs.appendChild(gradAB); defs.appendChild(gradAC);
  svg.appendChild(defs);
}

function ensureLine(id, stroke){
  let line=document.getElementById(id);
  if(!line){
    line=document.createElementNS("http://www.w3.org/2000/svg","path");
    line.setAttribute("id",id);
    line.setAttribute("fill","none");
    line.setAttribute("stroke-width","3");
    line.setAttribute("stroke-linecap","round");
    line.setAttribute("opacity","0.95");
    $("#wires").appendChild(line);
  }
  if(stroke) line.setAttribute("stroke",stroke);
  return line;
}
function removeLine(id){ const n=document.getElementById(id); if(n) n.remove(); }

function boardOffset(){ const b=$("#board").getBoundingClientRect(); return {left:b.left+window.scrollX, top:b.top+window.scrollY}; }
function mid(node){ const r=node.getBoundingClientRect(); return { x:r.left+r.width/2, y:r.top+r.height/2 }; }
function curve(p1,p2){
  const dx=(p2.x-p1.x)*0.35, c1={x:p1.x+dx,y:p1.y}, c2={x:p2.x-dx,y:p2.y}, off=boardOffset();
  const P1={x:p1.x-off.left,y:p1.y-off.top}, C1={x:c1.x-off.left,y:c1.y-off.top}, C2={x:c2.x-off.left,y:c2.y-off.top}, P2={x:p2.x-off.left,y:p2.y-off.top};
  return `M ${P1.x},${P1.y} C ${C1.x},${C1.y} ${C2.x},${C2.y} ${P2.x},${P2.y}`;
}

function findNodeById(col,id){ return state.nodeMap[col].find(x=>x.data.id===id)?.node||null; }

function drawProvisionalWiresForA(aNode){
  const chosenB=state.pairAB.get(aNode), chosenC=state.pairAC.get(aNode);
  const aPos=mid(aNode);
  if(chosenB){
    const bNode=findNodeById("B",chosenB); if(bNode){
      const bPos=mid(bNode);
      const id=`wire-ab-${chosenB}`;
      const path=curve(bPos,aPos);
      const line=ensureLine(id,"url(#gradAB)");
      line.setAttribute("d",path);
    }
  }
  if(chosenC){
    const cNode=findNodeById("C",chosenC); if(cNode){
      const cPos=mid(cNode);
      const id=`wire-ac-${chosenC}`;
      const path=curve(aPos,cPos);
      const line=ensureLine(id,"url(#gradAC)");
      line.setAttribute("d",path);
    }
  }
}

/* ========= Checking & Locking ========= */
function checkTripleForA(aNode){
  state.tries++; $("#tries").textContent=String(state.tries);

  const chosenB=state.pairAB.get(aNode);
  const chosenC=state.pairAC.get(aNode);

  const sameTriple = chosenB && chosenC && (chosenB===chosenC);
  const triple = DATA.find(d=>d.id===chosenB);
  const aLabel = aNode.textContent.trim();
  const labelMatches = triple && triple.A===aLabel;
  const isCorrect = sameTriple && labelMatches;

  const abId=`wire-ab-${chosenB}`, acId=`wire-ac-${chosenC}`;

  if(isCorrect){
    ensureLine(abId,"#2ecc71"); ensureLine(acId,"#2ecc71");
    lockTriple(chosenB);
    toast("Nice! Correct match üéâ");
    state.pairAB.delete(aNode); state.pairAC.delete(aNode);
  } else {
    ensureLine(abId,"#ff6b6b"); ensureLine(acId,"#ff6b6b");
    toast("Not quite ‚Äî adjust the links.");
    setTimeout(()=>{
      if(!state.lockedIds.has(chosenB)) removeLine(abId);
      if(!state.lockedIds.has(chosenC)) removeLine(acId);
    }, 900);
  }
  refreshWiresDeferred();
}

function lockTriple(tripleId){
  if(state.lockedIds.has(tripleId)) return;
  state.lockedIds.add(tripleId);
  $("#score").textContent=String(state.lockedIds.size);
  const bNode=findNodeById("B",tripleId), cNode=findNodeById("C",tripleId);
  if(bNode) bNode.classList.add("locked","correct");
  if(cNode) cNode.classList.add("locked","correct");

  const aNode = state.nodeMap.A.find(a=>a.data.label===DATA.find(d=>d.id===tripleId).A)?.node;
  if(aNode){ drawFinalWiresForTriple(aNode,tripleId); }

  if(state.lockedIds.size===DATA.length){
    stopTimerAndMaybeSetBest();
    // only allow saving if not DNF
    if(!(state.mode==="countdown" && (performance.now()-state.startMs)>=state.raceLimitMs)){
      showSaveModal(false);
      toast("All matched ‚Äî you win! üèÜ");
    }
  }
}

function drawFinalWiresForTriple(aNode,tripleId){
  const bNode=findNodeById("B",tripleId), cNode=findNodeById("C",tripleId);
  if(!bNode || !cNode) return;
  const aPos=mid(aNode), bPos=mid(bNode), cPos=mid(cNode);
  const ab=ensureLine(`wire-ab-${tripleId}`,"#2ecc71");
  const ac=ensureLine(`wire-ac-${tripleId}`,"#2ecc71");
  ab.setAttribute("d",curve(bPos,aPos));
  ac.setAttribute("d",curve(aPos,cPos));
}

/* ========= Wire maintenance ========= */
let refreshTimer=null;
function refreshWires(){
  for(const tripleId of state.lockedIds){
    const triple=DATA.find(d=>d.id===tripleId);
    const aNode = state.nodeMap.A.find(a=>a.data.label===triple.A)?.node;
    if(aNode) drawFinalWiresForTriple(aNode,tripleId);
  }
  for(const {node:aNode} of state.nodeMap.A){
    if(state.pairAB.has(aNode) || state.pairAC.has(aNode)) drawProvisionalWiresForA(aNode);
  }
}
function refreshWiresDeferred(){ clearTimeout(refreshTimer); refreshTimer=setTimeout(refreshWires,50); }
window.addEventListener("resize", refreshWiresDeferred);
document.addEventListener("scroll", refreshWiresDeferred, true);

/* ========= Timer UI & modal ========= */
function resetTimerUI(){
  if(state.tick){ clearInterval(state.tick); state.tick=null; }
  state.timerRunning=false; state.elapsedMs=0; state.startMs=0;
  updateTimeUI();
}
function showSaveModal(isDNF){
  const tries = String(state.tries);
  $("#modalTries").textContent = tries;
  const timeText = state.mode==="stopwatch" ? formatMs(state.elapsedMs)
                 : (isDNF ? "DNF" : `${formatMs(state.elapsedMs)} (finished with ${formatMs(state.raceLimitMs - state.elapsedMs)} left)`);
  $("#modalTime").textContent = timeText;
  $("#modalTitle").textContent = isDNF ? "Time up! (DNF) ‚Äî run again?" : "Great run! Save your time to the leaderboard";
  $("#btn-save").disabled = !!isDNF;
  $("#modal").classList.add("open");
  if(!isDNF) $("#name").focus();
}
function closeModal(){ $("#modal").classList.remove("open"); }
document.getElementById("btn-cancel").addEventListener("click", closeModal);
document.getElementById("btn-save").addEventListener("click", ()=>{
  const name = (document.getElementById("name").value || "").trim().slice(0,20);
  addToLB(name || "Anon", state.elapsedMs, state.tries);
  document.getElementById("name").value = "";
  closeModal();
});

/* ========= Leaderboard controls ========= */
document.getElementById("btn-reset-lb").addEventListener("click", ()=>{
  if(confirm(`Reset leaderboard for class "${CLASS_CODE}"?`)){
    localStorage.removeItem(LS_KEY_LB);
    renderLB();
  }
});
document.getElementById("btn-export").addEventListener("click", exportLB);

/* ========= Mode controls ========= */
const toggleCountdown = document.getElementById("toggle-countdown");
const selDuration = document.getElementById("race-duration");
toggleCountdown.addEventListener("change", ()=>{
  state.mode = toggleCountdown.checked ? "countdown" : "stopwatch";
  resetTimerUI();
  toast(state.mode==="countdown" ? "Countdown mode on ‚è≥" : "Stopwatch mode on ‚è±Ô∏è");
});
selDuration.addEventListener("change", ()=>{
  state.raceLimitMs = Number(selDuration.value || 120000);
  if(state.mode==="countdown") { resetTimerUI(); toast(`Countdown set to ${formatMs(state.raceLimitMs)}`); }
});

/* ========= Controls ========= */
$("#btn-shuffle").addEventListener("click",()=>{ buildBoard(); toast("New shuffle ready üîÄ"); });
$("#btn-reset").addEventListener("click",()=>{ buildBoard(); toast("Board reset ‚ôªÔ∏è"); });

/* ========= Init ========= */
function showBest(){ const raw=localStorage.getItem(LS_KEY_BEST); $("#best").textContent = raw ? formatMs(Number(raw)) : "‚Äî"; }
function renderLB(){ const tbody=$("#lb-body"); const rows=(loadLB().slice(0,10)); tbody.innerHTML=""; if(rows.length===0){const tr=el("tr",{},el("td",{colSpan:5},"No scores yet ‚Äî be the first!")); tbody.appendChild(tr); return;} rows.sort((a,b)=>a.ms-b.ms).forEach((r,i)=>{const tr=document.createElement("tr"); const dt=new Date(r.date); tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${formatMs(r.ms)}</td><td>${r.tries}</td><td>${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</td>`; tbody.appendChild(tr);}); }
renderLB(); showBest(); buildBoard();
</script>
</body>
</html>
